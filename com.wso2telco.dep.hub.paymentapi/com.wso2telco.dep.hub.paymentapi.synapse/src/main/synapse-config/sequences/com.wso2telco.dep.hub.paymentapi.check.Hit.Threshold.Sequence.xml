<?xml version="1.0" encoding="UTF-8"?>
<sequence name="com.wso2telco.dep.hub.paymentapi.check.Hit.Threshold.Sequence"
    xmlns="http://ws.apache.org/ns/synapse">

    <script language="js"><![CDATA[
        var requestedAmount = parseFloat(mc.getProperty('amount'));
        var configFraudAmount = parseFloat(mc.getProperty('maxValue'));
        var flag = false;

        if(requestedAmount > configFraudAmount) {
            flag = true;
        }

        mc.setProperty('paymentAmountFraud', flag);]]></script>

    <filter xpath="boolean($ctx:paymentAmountFraud)" xmlns:ns="http://org.apache.synapse/xsd">
        <then>
            <property name="PAYMENT_FRAUD_CAUSE" value="Exceeding maximum amount"/>
            <sequence key="com.wso2telco.dep.hub.paymentapi.alert.fraud.Sequence"/>
            <sequence key="com.wso2telco.dep.hub.paymentapi.customer.info.reader.Sequence"/>
        </then>
        <else>
            <class name="com.wso2telco.dep.common.mediation.spendlimit.mediator.FraudCacheLookupMediator"/>
            <filter xpath="boolean(get-property('fraudValue'))" xmlns:ns="http://org.apache.synapse/xsd">
                <then>
                    <script language="js"><![CDATA[
                        var cachedFraud = parseInt(mc.getProperty('fraudValue'));
                        var configHitCount = parseInt(mc.getProperty('hitCount'));
                        var flag = false;

                        if(cachedFraud > configHitCount) {
                            flag = true;
                        }

                        mc.setProperty('paymentHitCountFraud', flag);]]></script>
                    <filter xpath="boolean($ctx:paymentHitCountFraud)">
                        <then>
                            <property name="PAYMENT_FRAUD_CAUSE" value="Exceeding maximum hit count for payment"/>
                            <sequence key="com.wso2telco.dep.hub.paymentapi.alert.fraud.Sequence"/>
                            <sequence key="com.wso2telco.dep.hub.paymentapi.customer.info.reader.Sequence"/>
                        </then>
                        <else/>
                    </filter>
                </then>
                <else/>
            </filter>
        </else>
    </filter>

    <class name="com.wso2telco.dep.common.mediation.spendlimit.mediator.FraudCacheMediator"/>

    <filter xpath="(not(boolean($ctx:paymentAmountFraud)) and not(boolean($ctx:paymentHitCountFraud)))" xmlns:ns="http://org.apache.synapse/xsd">
        <then>
            <!-- retrieve the package type from cache -->
            <sequence key="com.wso2telco.dep.hub.paymentapi.cache.lookup.Sequence"/>

            <filter regex="true" source="boolean(get-property('userpackagetype'))" xmlns:ns="http://org.apache.synapse/xsd">
                <then>
                    <sequence key="com.wso2telco.dep.hub.paymentapi.default.package.type.set.Sequence"/>
                </then>
                <else>
                    <sequence key="com.wso2telco.dep.hub.paymentapi.customer.info.reader.Sequence"/>
                </else>
            </filter>
        </then>
        <else/>
    </filter>
</sequence>
